<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ultimate Movie/TV Player</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
<style>
body{background:#0e0f14;color:#fff;font-family:Arial,sans-serif;}
.hidden{display:none;}
.search-results{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:15px;margin-top:20px;}
.result-card{background:#151823;border-radius:10px;overflow:hidden;cursor:pointer;transition:.2s;}
.result-card:hover{transform:scale(1.05);}
.result-card img{width:100%;height:220px;object-fit:cover;}
.result-card .info{padding:10px;font-size:14px;}
.player-container{width:100%;aspect-ratio:16/9;background:#000;border-radius:12px;overflow:hidden;}
.video-player{width:100%;height:100%;border:none;}
.controls{padding:20px;background:#151823;border-radius:12px;margin-top:15px;}
.movie-title{font-size:22px;font-weight:bold;}
.download-btn{background:#23d5ab;border:none;padding:10px 20px;border-radius:6px;font-weight:bold;cursor:pointer;margin-top:10px;}
.history-list{margin-top:20px;}
.history-item{cursor:pointer;color:#23d5ab;text-decoration:underline;}
.language-select{margin:10px 0;width:150px;}
</style>
</head>
<body>
<div class="container py-4">

  <!-- Search Section -->
  <div id="inputSection" class="text-center">
    <h2>Search Movie / TV Show</h2>
    <input type="text" id="movieNameInput" class="form-control w-50 mx-auto my-3" placeholder="Enter name">
    <button class="btn btn-primary" onclick="searchMovie()">Search</button>
    <div class="search-results" id="searchResults"></div>
    <div class="history-list" id="historyList"></div>
  </div>

  <!-- Player Section -->
  <div id="playerSection" class="hidden">
    <button class="btn btn-secondary mb-3" onclick="goBack()">⬅ Back</button>
    <div class="player-container">
      <iframe id="videoPlayer" class="video-player" allowfullscreen></iframe>
    </div>

    <div class="controls mt-3">
      <h2 class="movie-title" id="movieTitle">Loading...</h2>
      <p><span id="movieYear"></span> • Rating: <span id="movieRating"></span></p>

      <!-- TV Controls -->
      <div id="tvControls" class="hidden">
        <label>Season:</label>
        <select id="seasonSelect"></select>
        <label>Episode:</label>
        <select id="episodeSelect"></select>
      </div>

      <!-- Language -->
      <select id="languageSelect" class="form-control language-select" onchange="autoSelectServer()">
        <option value="hi" selected>Hindi</option>
        <option value="en">English</option>
      </select>

      <!-- Servers -->
      <label class="mt-2">Select Server:</label>
      <select id="serverSelect" class="form-control w-50 mx-auto my-2"></select>

      <button class="download-btn" id="downloadBtn">⬇ Download</button>
    </div>
  </div>

</div>

<script>
const cfg={BASE:"https://api.themoviedb.org/3/",KEY:"fed86956458f19fb45cdd382b6e6de83",IMG:"https://image.tmdb.org/t/p/w300"};

// servers array me manually paste karenge jo ServerGenerator se milega
let servers=[
 {name:"EmbedSU Hindi",movie:id=>`https://embed.su/embed/movie/${id}`,tv:(id,s,e)=>`https://embed.su/embed/tv/${id}/${s}/${e}`},
 {name:"MoviesAPI English",movie:id=>`https://moviesapi.club/movie/${id}`,tv:(id,s,e)=>`https://moviesapi.club/tv/${id}-${s}-${e}`}
];

let movieId=null,mediaType="movie",currentSeason=1,currentEpisode=1,availableServers=[],historyStack=[];

async function fetchAPI(endpoint){
  const res=await fetch(`${cfg.BASE}${endpoint}?api_key=${cfg.KEY}&language=en-US`);
  return res.json();
}

async function searchMovie(){
 const q=document.getElementById("movieNameInput").value.trim(); if(!q)return;
 historyStack.push({type:"search",query:q}); renderHistory();
 const res=await fetch(`${cfg.BASE}search/multi?api_key=${cfg.KEY}&language=en-US&query=${encodeURIComponent(q)}`);
 const data=await res.json();
 const resultsDiv=document.getElementById("searchResults");resultsDiv.innerHTML="";
 data.results.forEach(item=>{
   if(!item.id)return;
   const title=item.title||item.name;
   const year=(item.release_date||item.first_air_date||"").split("-")[0]||"N/A";
   const poster=item.poster_path?cfg.IMG+item.poster_path:"https://via.placeholder.com/300x450?text=No+Image";
   const card=document.createElement("div");card.className="result-card";
   card.innerHTML=`<img src="${poster}"><div class="info"><b>${title}</b><br>${year} • ${item.media_type.toUpperCase()}</div>`;
   card.onclick=()=>startPlayer(item.id,item.media_type);
   resultsDiv.appendChild(card);
 });
}

async function loadDetails(){
 const data=await fetchAPI(`${mediaType}/${movieId}`);
 const title=data.title||data.name;
 const year=(data.release_date||data.first_air_date||"").split("-")[0];
 document.getElementById("movieTitle").textContent=title;
 document.getElementById("movieYear").textContent=year||"N/A";
 document.getElementById("movieRating").textContent=data.vote_average?.toFixed(1)||"0.0";
 if(mediaType==="tv"){setupTV(data);}else{document.getElementById("tvControls").classList.add("hidden");}
}

function setupTV(data){
 const seasonSelect=document.getElementById("seasonSelect");
 const episodeSelect=document.getElementById("episodeSelect");
 seasonSelect.innerHTML=""; episodeSelect.innerHTML="";
 data.seasons.forEach(season=>{
   if(season.season_number>0){
     const opt=document.createElement("option");
     opt.value=season.season_number; opt.textContent=`Season ${season.season_number}`;
     seasonSelect.appendChild(opt);
   }
 });
 seasonSelect.onchange=async()=>{
   currentSeason=parseInt(seasonSelect.value);
   const seasonData=await fetchAPI(`tv/${movieId}/season/${currentSeason}`);
   episodeSelect.innerHTML="";
   seasonData.episodes.forEach(ep=>{
     const opt=document.createElement("option");
     opt.value=ep.episode_number; opt.textContent=`Episode ${ep.episode_number}`;
     episodeSelect.appendChild(opt);
   });
   episodeSelect.onchange=()=>{currentEpisode=parseInt(episodeSelect.value);autoSelectServer();};
   currentEpisode=parseInt(episodeSelect.value)||1;
   autoSelectServer();
 };
 currentSeason=parseInt(seasonSelect.value)||1;
 currentEpisode=1;
 document.getElementById("tvControls").classList.remove("hidden");
}

function testServer(url){return new Promise(res=>{
 const f=document.createElement("iframe");
 f.src=url; f.style.display="none"; document.body.appendChild(f);
 let ok=false;
 f.onload=()=>{ok=true; f.remove(); res(true);};
 setTimeout(()=>{if(!ok)f.remove(); res(ok);},2000);
});}

async function autoSelectServer(){
 availableServers=[];
 const lang=document.getElementById("languageSelect").value;
 for(let srv of servers){
   if(lang==="hi" && !srv.name.toLowerCase().includes("hindi")) continue;
   if(lang==="en" && !srv.name.toLowerCase().includes("english")) continue;

   let url=mediaType==="tv"?srv.tv(movieId,currentSeason,currentEpisode):srv.movie(movieId);
   let ok=await testServer(url);
   if(ok)availableServers.push({name:srv.name,url});
 }
 const sel=document.getElementById("serverSelect");sel.innerHTML="";
 if(availableServers.length>0){
   availableServers.forEach(srv=>{
     const opt=document.createElement("option");
     opt.value=srv.url; opt.textContent=srv.name;
     sel.appendChild(opt);
   });
   document.getElementById("videoPlayer").src=availableServers[0].url;
 } else {
   document.getElementById("videoPlayer").src="";
   alert("No server works for selected language!");
 }
 sel.onchange=()=>{document.getElementById("videoPlayer").src=sel.value;};
}

function startPlayer(id,type){
 movieId=id; mediaType=type; historyStack.push({type:"play",id,type});
 document.getElementById("inputSection").classList.add("hidden");
 document.getElementById("playerSection").classList.remove("hidden");
 loadDetails(); autoSelectServer();
 document.getElementById("downloadBtn").onclick=()=>{
   let durl=mediaType==="tv"?`https://dl.vidsrc.vip/tv/${movieId}/${currentSeason}/${currentEpisode}`:`https://dl.vidsrc.vip/movie/${movieId}`;
   window.open(durl,"_blank");
 };
}

function goBack(){
 historyStack.pop();
 document.getElementById("playerSection").classList.add("hidden");
 document.getElementById("inputSection").classList.remove("hidden");
}

function renderHistory(){
 const div=document.getElementById("historyList");div.innerHTML="<h5>History:</h5>";
 historyStack.forEach(h=>{
   if(h.type==="search"){
     const el=document.createElement("div");el.className="history-item";el.textContent="Search: "+h.query;
     el.onclick=()=>{document.getElementById("movieNameInput").value=h.query;searchMovie();};
     div.appendChild(el);
   }
 });
}
</script>
</body>
</html>
